<!DOCTYPE html>
<html>
  <head>
    <style>
    input::placeholder {
      font-weight: bold;
      opacity: 0.5;
      text-align: right;
    }

    .messageRole {
      color: red;
      width:100%;
      text-align: right;
      direction: rtl;
    }

    .message {
      color: black;
      width:100%;
      text-align: right;
      direction: rtl;
    }
    </style>
    <script src="personifyClient.js"></script>
    <script src="personify.js"></script>
    <script src="conversationComponent.js"></script>
  </head>
  <body style="margin:0">
    <div id="home" style="display:none">
      <input type="button" value="Start a new conversation" onclick="startNewConversation()" />
      <br><br>
      <input type="button" value="Continue a conversation" onclick="continueConversation()" />
    </div>

    <div id="conversation"></div>

    <script>
      const personify = new Personify();

      function hideHome() {
        document.getElementById('home').style.display = 'none';
      }

      function startNewConversation(systemPrompt) {
        hideHome();

        if (systemPrompt === undefined) {
          systemPrompt = prompt("Enter system prompt:");
        }

        if (systemPrompt === null || systemPrompt === undefined || systemPrompt === '') {
          document.body.innerHTML = 'system prompt cannot be empty, refresh the page to start over';
        } else {
          personify.startConversation(systemPrompt).then((conversation) => {
            localStorage.lastConversationId = conversation.conversationId;

            const conversationComponent = new ConversationComponent({
              containerElementId: 'conversation',
              conversation: conversation,
              isRenderOldChatMessages: false,
            });
          });
        }
      }

      async function continueConversation(conversationId) {
        hideHome();

        if (conversationId === undefined) {
          conversationId = prompt("Enter conversation Id:");
        }

        if (conversationId === undefined) {
          throw new Error('conversationId is undefined');
        }

        const conversation = await personify.loadConversation(conversationId);

        localStorage.lastConversationId = conversation.conversationId;

        const conversationComponent = new ConversationComponent({
          containerElementId: 'conversation',
          conversation: conversation,
          isRenderOldChatMessages: true,
        });
      }

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const result = {};

        for (const [key, value] of params.entries()) {
          if (
            value !== undefined &&
            value !== null &&
            value !== ''
          ) {
            result[key] = value;
          }
        }

        return result;
      }

      async function index() {
        // queryParams['op'] possible values:
        const OP_CONTINUE = 'continueConversation'.toLowerCase();
        const OP_NEW = 'startNewConversation'.toLowerCase();

        const queryParams = getQueryParams();

        let op = OP_CONTINUE;

        if (queryParams['op'] !== undefined) {
          op = String(queryParams['op']).toLowerCase();

          if (
            op !== OP_CONTINUE &&
            op !== OP_NEW
          ) {
            op = OP_CONTINUE;
          }
        }

        if (op === OP_CONTINUE) {
          let conversationId;

          if (queryParams['id'] !== undefined) {
            conversationId = String(queryParams['id']);
          } else {
            conversationId = localStorage.lastConversationId;
          }

          if (
            conversationId !== undefined &&
            conversationId !== null &&
            conversationId !== ''
          ) {
            try {
              await continueConversation(conversationId);
            } catch {
              console.log('apparently conversation does not exist on the server, lets start a new one');
              op = OP_NEW;
            }
          } else {
            op = OP_NEW;
          }
        }

        if (op === OP_NEW) {
          let systemPrompt = "אתה ילד בן 10 מישראל. קוראים לך אופק. אם שואלים אותך 'איך קוראים לך?' תענה 'אופק'. אם שואלים אותך 'מה שמך?', תענה 'אופק'. אם שואלים אותך 'מה השם שלך?', תענה 'אופק'. אתה גר בעיר הוד השרון. יש לך אחות קטנה ממך בת 7, אתם גרים עם אמא כי אבא עזב לפני שנה. אתה לא מבין הרבה דברים על העולם המבוגר, והדברים שאתה אומר הם פשוטים. תמיד תדבר בעברית. תמיד תכתוב מימין לשמאל. אל תוסיף נקודה בסוף משפט";

          if (queryParams['prompt'] !== undefined) {
            systemPrompt = String(queryParams['prompt']);
          }

          startNewConversation(systemPrompt);
        }
      }

      index();

    </script>
  </body>
</html>